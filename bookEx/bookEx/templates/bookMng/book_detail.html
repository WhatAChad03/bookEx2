{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container" style="max-width:900px; margin-top:40px;">
  <h1 class="mb-4" style="font-weight: 700; color: var(--primary);">{{ book.name }}</h1>

  <div style="display: flex; flex-wrap: wrap; gap: 25px;">
    <div style="flex: 0 0 250px;">
      <img src="{% static book.pic_path %}" alt="{{ book.name }} Cover" style="width: 100%; border-radius: 10px; box-shadow: 0 0 20px var(--primary); border: 1px solid var(--border);" />
    </div>

    <div style="flex: 1; min-width: 300px; color: var(--text-primary); font-size: 16px;">
      <p><strong>Price:</strong> ${{ book.price }}</p>
      <p><strong>Posted by:</strong> {{ book.username }}</p>
      <p><strong>Date:</strong> {{ book.publishdate }}</p>
      <p><strong>Website:</strong>
        <form action="{{ book.web }}" method="get" target="_blank" style="display:inline;">
          <button type="submit" style="background: var(--primary); color: white; border: none; padding: 7px 18px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 700; text-decoration: none;">
            Visit Website
          </button>
        </form>
      </p>

      {% if user.is_authenticated %}
      <form action="{% url 'add_to_cart' book.id %}" method="get" style="margin-top: 20px;">
        <button type="submit" class="btn btn-primary" style="padding: 12px 22px; font-weight: 700; display: inline-block;">
          Add to Cart
        </button>
      </form>
      {% else %}
      <form action="{% url 'login' %}" method="get">
        <button type="submit" class="btn btn-secondary" style="padding: 12px 22px; font-weight: 700;">Login to purchase this book</button>
      </form>
      {% endif %}

      {% if user == book.username %}
      <form action="{% url 'edit_book' book.id %}" method="get" style="margin-top: 20px;">
        <button type="submit" class="btn btn-outline-primary" style="padding: 8px 16px;">Edit Book</button>
      </form>
      {% endif %}

      <div style="margin-top: 20px; display:flex; flex-wrap:wrap; gap: 8px;">
        <form action="{% url 'rate_book' book.id %}" method="get" style="display:inline;">
          <button type="submit" class="btn btn-warning" style="padding: 12px 22px; font-weight: 700;">Rate this Book</button>
        </form>
        <form action="{% url 'searchbooks' %}" method="get" style="display:inline;">
          <button type="submit" class="btn btn-secondary" style="padding: 12px 22px;">Back to Search</button>
        </form>
        {% if user.is_authenticated %}
          <form action="{% url 'toggle_favorite' book.id %}" method="post" style="display:inline;">{% csrf_token %}
            {% if user in book.favorites.all %}
              <button type="submit" class="btn btn-danger" style="padding: 12px 22px;">Remove from Favorites</button>
            {% else %}
              <button type="submit" class="btn btn-outline-primary" style="padding: 12px 22px;">Add to Favorites</button>
            {% endif %}
          </form>
        {% endif %}
      </div>

      <h3 style="margin-top: 40px; color: var(--primary);">Ratings</h3>
      {% if ratings %}
        <p><strong>Average Rating:</strong>
          {% if avg_rating %}
            <span>
              {% for i in "12345" %}
                {% if avg_rating|floatformat:1 >= i %}
                  <span style="color:#FFD700; font-size:1.5rem;">★</span>
                {% elif avg_rating|floatformat:1 > i|add:"-1" %}
                  <span style="position: relative; font-size:1.5rem;">
                    <span style="color:#FFD700; position:absolute; overflow:hidden; width:50%;">★</span>
                    <span style="color:#ccc;">★</span>
                  </span>
                {% else %}
                  <span style="color:#ccc; font-size:1.5rem;">★</span>
                {% endif %}
              {% endfor %}
            </span>
            ({{ avg_rating }}/5)
          {% else %}
            No ratings yet
          {% endif %}
        </p>

        <ul style="list-style:none; padding-left:0;">
          {% for rate in ratings %}
          <li style="margin-bottom: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 6px; display: flex; align-items: center; justify-content: space-between;">
            <div>
              <strong>{% if rate.user == user %}You{% else %}Anonymous{% endif %}</strong> :
              <span>
                {% for i in "12345" %}
                  {% if i|add:"0" <= rate.rating %}
                    <span style="color:#FFD700; font-size:1.3rem;">★</span>
                  {% else %}
                    <span style="color:#ccc; font-size:1.3rem;">★</span>
                  {% endif %}
                {% endfor %}
              </span>
            </div>
            {% if rate.user == user %}
            <form method="post" action="{% url 'delete_rating' rate.id %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit" style="background: #dc3545; color: white; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer;">Delete</button>
            </form>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <form action="{% url 'rate_book' book.id %}" method="get" style="display:inline;">
          <button type="submit" class="btn btn-outline-primary">Be the first to rate this book</button>
        </form>
      {% endif %}

      <h3 style="margin-top: 40px; color: var(--primary);">Comments</h3>
      {% if user.is_authenticated %}
        <form method="post" action="{% url 'add_comment' book.id %}">
          {% csrf_token %}
          <textarea name="content" rows="3" placeholder="Add your comment here" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); margin-bottom: 12px; font-size: 1rem;"></textarea>
          <button type="submit" class="btn btn-primary" style="padding: 12px 22px; font-weight: 700;">Submit Comment</button>
        </form>
      {% else %}
        <form action="{% url 'login' %}" method="get">
          <button type="submit" class="btn btn-secondary">Login to add comments</button>
        </form>
      {% endif %}

      {% if book.comments.all %}
        <ul style="list-style:none; padding-left:0; margin-top: 20px;">
          {% for comment in book.comments.all %}
            <li style="background: var(--bg-secondary); margin-bottom: 12px; border-radius: 6px; padding: 12px;">
              <strong>{{ comment.user.username }}</strong>
              <small style="color: var(--text-secondary); margin-left: 12px;">{{ comment.created_at|date:"M d, Y H:i" }}</small>

              {% if user == comment.user and request.GET.edit_comment|stringformat:"s" == comment.id|stringformat:"s" %}
                <form method="post" action="{% url 'edit_comment' comment.id %}">
                  {% csrf_token %}
                  <textarea name="content" rows="3" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); margin-top: 8px; font-size: 1rem;">{{ comment.content }}</textarea>
                  <button type="submit" class="btn btn-primary" style="margin-top: 8px;">Save</button>
                  <a href="{% url 'book_detail' book.id %}" class="btn btn-secondary" style="margin-left: 8px; margin-top: 8px;">Cancel</a>
                </form>
              {% else %}
                <p style="margin-top: 6px;">{{ comment.content }}</p>
                {% if user == comment.user %}
                  <form method="get" action="{% url 'book_detail' book.id %}" style="display:inline;">
                    <input type="hidden" name="edit_comment" value="{{ comment.id }}">
                    <button type="submit" class="btn btn-outline-primary btn-sm">Edit</button>
                  </form>
                  <form method="post" action="{% url 'delete_comment' comment.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" style="background: var(--primary); color: white; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Delete</button>
                  </form>
                {% endif %}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No comments yet. Be the first to add one!</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
