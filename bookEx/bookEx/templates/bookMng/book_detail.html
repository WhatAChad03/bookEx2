{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container" style="max-width:900px; margin-top:40px;">

  <h1 class="mb-4" style="font-weight: 700; color: var(--primary);">{{ book.name }}</h1>

  <div style="display: flex; flex-wrap: wrap; gap: 25px;">

    <div style="flex: 0 0 250px;">
      <img src="{% static book.pic_path %}" alt="{{ book.name }} Cover" style="width: 100%; border-radius: 10px; box-shadow: 0 0 20px var(--primary); border: 1px solid var(--border);" />
    </div>

    <div style="flex: 1; min-width: 300px; color: var(--text-primary); font-size: 16px;">

      <p><strong>Price:</strong> ${{ book.price }}</p>
      <p><strong>Posted by:</strong> {{ book.username }}</p>
      <p><strong>Date:</strong> {{ book.publishdate }}</p>
      <p><strong>Website:</strong> <a href="{{ book.web }}" target="_blank" style="color: var(--primary); text-decoration: underline;">{{ book.web }}</a></p>

      <div style="margin-top: 20px;">
        <a href="{% url 'rate_book' book.id %}" class="btn btn-warning" style="padding: 12px 22px; font-weight: 700;">Rate this Book</a>
        <a href="{% url 'searchbooks' %}" class="btn btn-secondary" style="padding: 12px 22px; margin-left: 8px;">Back to Search</a>

        {% if user.is_authenticated %}
          {% if user in book.favorites.all %}
            <a href="{% url 'toggle_favorite' book.id %}" class="btn btn-danger" style="padding: 12px 22px; margin-left: 8px;">Remove from Favorites</a>
          {% else %}
            <a href="{% url 'toggle_favorite' book.id %}" class="btn btn-outline-primary" style="padding: 12px 22px; margin-left: 8px;">Add to Favorites</a>
          {% endif %}
        {% endif %}
      </div>

      <h3 style="margin-top: 40px; color: var(--primary);">Ratings</h3>
      {% if ratings %}
        <p><strong>Average Rating:</strong> {{ avg_rating|default:"No ratings yet" }}</p>
        <ul style="list-style:none; padding-left:0;">
          {% for rate in ratings %}
          <li style="margin-bottom: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;">
            <strong>{% if rate.user == user %}You{% else %}Anonymous{% endif %}</strong> : {{ rate.rating }} / 5
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No ratings yet. Be the first to <a href="{% url 'rate_book' book.id %}">rate this book</a>.</p>
      {% endif %}

      <h3 style="margin-top: 40px; color: var(--primary);">Comments</h3>
      {% if user.is_authenticated %}
        <form method="post" action="{% url 'add_comment' book.id %}">
          {% csrf_token %}
          <textarea name="content" rows="3" placeholder="Add your comment here" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); margin-bottom: 12px; font-size: 1rem;"></textarea>
          <button type="submit" class="btn btn-primary" style="padding: 12px 22px; font-weight: 700;">Submit Comment</button>
        </form>
      {% else %}
        <p><a href="{% url 'login' %}">Login</a> to add comments.</p>
      {% endif %}

      {% if book.comments.all %}
        <ul style="list-style:none; padding-left:0; margin-top: 20px;">
          {% for comment in book.comments.all %}
            <li style="background: var(--bg-secondary); margin-bottom: 12px; border-radius: 6px; padding: 12px;">
              <strong>{{ comment.user.username }}</strong>
              <small style="color: var(--text-secondary); margin-left: 12px;">{{ comment.created_at|date:"M d, Y H:i" }}</small>
              <p style="margin-top: 6px;">{{ comment.content }}</p>
              {% if comment.user == user %}
                <form method="post" action="{% url 'delete_comment' comment.id %}" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" style="background: var(--primary); color: white; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer;">Delete</button>
                </form>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No comments yet. Be the first to add one!</p>
      {% endif %}
    </div>

  </div>
</div>
{% endblock content %}
