{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div style="max-width: 800px; margin: 2rem auto; background: var(--bg-secondary); border-radius: 12px; padding: 2rem; box-shadow: var(--shadow);">
  <h2 style="font-weight: 700; color: var(--primary); margin-bottom: 1.5rem;">Checkout</h2>

  {% if cart_items %}
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: var(--primary); color: white;">
          <th>Image</th>
          <th>Title</th>
          <th>Rating</th>
          <th>Quantity</th>
          <th>Unit Price</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for item in cart_items %}
        <tr style="background: var(--bg-primary); text-align: center;">
          <td>
            <img src="{% static item.book.pic_path %}" alt="{{ item.book.name }}" style="width: 70px; height: 100px; object-fit: cover; border-radius: 6px;">
          </td>
          <td style="font-weight: 600;">
            <a href="{% url 'book_detail' item.book.id %}" style="color: var(--primary); text-decoration: none;">
              {{ item.book.name }}
            </a>
          </td>
          <td>
            {% for i in "12345" %}
              {% if i|add:'0' <= item.book.average_rating %}
                <span style="color:#FFD700;">★</span>
              {% else %}
                <span style="color:#ccc;">★</span>
              {% endif %}
            {% endfor %}
            <br>({{ item.book.average_rating|floatformat:1 }}/5)
          </td>
          <td>
            <form method="post" action="{% url 'update_cart_quantity' item.book.id %}">
              {% csrf_token %}
              <input type="number" name="quantity" value="{{ item.quantity }}" min="1" style="width: 50px;">
              <button type="submit">Update</button>
            </form>
          </td>
          <td>${{ item.book.price }}</td>
          <td>${{ item.quantity|mul:item.book.price|floatformat:2 }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <hr style="margin: 1.5rem 0; border: 1px solid var(--border);">

    <p style="font-weight: 700; font-size: 1.2rem; text-align: right;">
      Total: ${{ total_price|floatformat:2 }}
    </p>

    <form method="post" style="margin-top: 16px;" action="{% url 'checkout' %}">
      {% csrf_token %}
      <button type="submit" style="padding: 12px 24px; font-weight: 700; font-size: 1rem; border: none; border-radius: 8px; background: var(--primary); color: white;">Confirm Purchase</button>
    </form>

    <form method="post" style="display: inline; margin-left: 10px;" action="{% url 'cancel_checkout' %}">
      {% csrf_token %}
      <button type="submit" style="padding: 12px 24px; font-weight: 700; border-radius: 8px; background: var(--text-secondary); color: white; border: none; cursor: pointer;">Cancel</button>
    </form>

  {% else %}
  <p style="font-style: italic; color: var(--text-secondary); font-size: 1.1rem;">Your cart is empty.</p>
  {% endif %}
</div>
{% endblock %}
